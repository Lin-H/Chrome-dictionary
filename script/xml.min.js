var isArray=Array.isArray;var indent_string="\t";var xml_header='<?xml version="1.0"?>';var sort_args=null;var re_valid_tag_name=/^\w[\w\-\:]*$/;var XML=function XML(a){if(!a){a=""}if(isa_hash(a)){for(var b in a){this[b]=a[b]}}else{this.text=a||""}if(this.text instanceof Buffer){this.text=this.text.toString()}this.tree={};this.errors=[];this.piNodeList=[];this.dtdNodeList=[];this.documentNodeName="";if(this.lowerCase){this.attribsKey=this.attribsKey.toLowerCase();this.dataKey=this.dataKey.toLowerCase()}this.patTag.lastIndex=0;if(this.text){this.parse()}};XML.prototype.preserveAttributes=false;XML.prototype.lowerCase=false;XML.prototype.patTag=/([^<]*?)<([^>]+)>/g;XML.prototype.patSpecialTag=/^\s*([\!\?])/;XML.prototype.patPITag=/^\s*\?/;XML.prototype.patCommentTag=/^\s*\!--/;XML.prototype.patDTDTag=/^\s*\!DOCTYPE/;XML.prototype.patCDATATag=/^\s*\!\s*\[\s*CDATA/;XML.prototype.patStandardTag=/^\s*(\/?)([\w\-\:\.]+)\s*([\s\S]*)$/;XML.prototype.patSelfClosing=/\/\s*$/;XML.prototype.patAttrib=new RegExp("([\\w\\-\\:\\.]+)\\s*=\\s*([\\\"\\'])([^\\2]*?)\\2","g");XML.prototype.patPINode=/^\s*\?\s*([\w\-\:]+)\s*(.*)$/;XML.prototype.patEndComment=/--$/;XML.prototype.patNextClose=/([^>]*?)>/g;XML.prototype.patExternalDTDNode=new RegExp('^\\s*\\!DOCTYPE\\s+([\\w\\-\\:]+)\\s+(SYSTEM|PUBLIC)\\s+\\"([^\\"]+)\\"');XML.prototype.patInlineDTDNode=/^\s*\!DOCTYPE\s+([\w\-\:]+)\s+\[/;XML.prototype.patEndDTD=/\]$/;XML.prototype.patDTDNode=/^\s*\!DOCTYPE\s+([\w\-\:]+)\s+\[(.*)\]/;XML.prototype.patEndCDATA=/\]\]$/;XML.prototype.patCDATANode=/^\s*\!\s*\[\s*CDATA\s*\[([^]*)\]\]/;XML.prototype.attribsKey="_Attribs";XML.prototype.dataKey="_Data";XML.prototype.parse=function(j,b){if(!j){j=this.tree}if(!b){b=null}var n=false;var d=null;while(d=this.patTag.exec(this.text)){var i=d[1];var o=d[2];if(i.match(/\S/)){if(typeof(j[this.dataKey])!="undefined"){j[this.dataKey]+=" "}else{j[this.dataKey]=""}j[this.dataKey]+=trim(decode_entities(i))}if(o.match(this.patSpecialTag)){if(o.match(this.patPITag)){o=this.parsePINode(o)}else{if(o.match(this.patCommentTag)){o=this.parseCommentNode(o)}else{if(o.match(this.patDTDTag)){o=this.parseDTDNode(o)}else{if(o.match(this.patCDATATag)){o=this.parseCDATANode(o);if(typeof(j[this.dataKey])!="undefined"){j[this.dataKey]+=" "}else{j[this.dataKey]=""}j[this.dataKey]+=trim(decode_entities(o))}else{this.throwParseError("Malformed special tag",o);break}}}}if(o==null){break}continue}else{var d=o.match(this.patStandardTag);if(!d){this.throwParseError("Malformed tag",o);break}var c=d[1];var h=this.lowerCase?d[2].toLowerCase():d[2];var g=d[3];if(c){if(h==(b||"")){n=1;break}else{this.throwParseError("Mismatched closing tag (expected </"+b+">)",o);break}}else{var f=!!g.match(this.patSelfClosing);var e={};var a=e;if(this.preserveAttributes){e[this.attribsKey]={};a=e[this.attribsKey]}this.patAttrib.lastIndex=0;while(d=this.patAttrib.exec(g)){var k=this.lowerCase?d[1].toLowerCase():d[1];a[k]=decode_entities(d[3])}if(this.preserveAttributes&&!num_keys(a)){delete e[this.attribsKey]}if(!f){this.parse(e,h);if(this.error()){break}}var m=num_keys(e);if((typeof(e[this.dataKey])!="undefined")&&(m==1)){e=e[this.dataKey]}else{if(!m){e=""}}if(typeof(j[h])!="undefined"){if(isa_array(j[h])){j[h].push(e)}else{var l=j[h];j[h]=[l,e]}}else{j[h]=e}if(this.error()||(j==this.tree)){break}}}}if(b&&!n){this.throwParseError("Missing closing tag (expected </"+b+">)",b)}if(j==this.tree){if(typeof(this.tree[this.dataKey])!="undefined"){delete this.tree[this.dataKey]}if(num_keys(this.tree)>1){this.throwParseError("Only one top-level node is allowed in document",first_key(this.tree));return}this.documentNodeName=first_key(this.tree);if(this.documentNodeName){this.tree=this.tree[this.documentNodeName]}}};XML.prototype.throwParseError=function(d,a){var c=this.text.substring(0,this.patTag.lastIndex);var b=c.match(/\n/g);var e=(b?b.length:0)+1;e-=a.match(/\n/)?a.match(/\n/g).length:0;this.errors.push({type:"Parse",key:d,text:"<"+a+">",line:e});throw new Error(this.getLastError())};XML.prototype.error=function(){return this.errors.length};XML.prototype.getError=function(a){var b="";if(!a){return""}b=(a.type||"General")+" Error";if(a.code){b+=" "+a.code}b+=": "+a.key;if(a.line){b+=" on line "+a.line}if(a.text){b+=": "+a.text}return b};XML.prototype.getLastError=function(){if(!this.error()){return""}return this.getError(this.errors[this.errors.length-1])};XML.prototype.parsePINode=function(a){if(!a.match(this.patPINode)){this.throwParseError("Malformed processor instruction",a);return null}this.piNodeList.push(a);return a};XML.prototype.parseCommentNode=function(a){var b=null;this.patNextClose.lastIndex=this.patTag.lastIndex;while(!a.match(this.patEndComment)){if(b=this.patNextClose.exec(this.text)){a+=">"+b[1]}else{this.throwParseError("Unclosed comment tag",a);return null}}this.patTag.lastIndex=this.patNextClose.lastIndex;return a};XML.prototype.parseDTDNode=function(a){var b=null;if(a.match(this.patExternalDTDNode)){this.dtdNodeList.push(a)}else{if(a.match(this.patInlineDTDNode)){this.patNextClose.lastIndex=this.patTag.lastIndex;
while(!a.match(this.patEndDTD)){if(b=this.patNextClose.exec(this.text)){a+=">"+b[1]}else{this.throwParseError("Unclosed DTD tag",a);return null}}this.patTag.lastIndex=this.patNextClose.lastIndex;if(a.match(this.patDTDNode)){this.dtdNodeList.push(a)}else{this.throwParseError("Malformed DTD tag",a);return null}}else{this.throwParseError("Malformed DTD tag",a);return null}}return a};XML.prototype.parseCDATANode=function(a){var b=null;this.patNextClose.lastIndex=this.patTag.lastIndex;while(!a.match(this.patEndCDATA)){if(b=this.patNextClose.exec(this.text)){a+=">"+b[1]}else{this.throwParseError("Unclosed CDATA tag",a);return null}}this.patTag.lastIndex=this.patNextClose.lastIndex;if(b=a.match(this.patCDATANode)){return b[1]}else{this.throwParseError("Malformed CDATA tag",a);return null}};XML.prototype.getTree=function(){return this.tree};XML.prototype.compose=function(){var e=compose_xml(this.tree,this.documentNodeName);var c=e.substring(e.indexOf("\n")+1,e.length);var d="";if(this.piNodeList.length){for(var b=0,a=this.piNodeList.length;b<a;b++){d+="<"+this.piNodeList[b]+">"+"\n"}}else{d+=xml_header+"\n"}if(this.dtdNodeList.length){for(var b=0,a=this.dtdNodeList.length;b<a;b++){d+="<"+this.dtdNodeList[b]+">"+"\n"}}d+=c;return d};var parse_xml=function parse_xml(b,a){if(!a){a={}}a.text=b;var c=new XML(a);return c.error()?c.getLastError():c.getTree()};var trim=function trim(a){if(a==null){return""}if(a&&a.replace){a=a.replace(/^\s+/,"");a=a.replace(/\s+$/,"")}return a};var encode_entities=function encode_entities(a){if(a==null){return""}if(a&&a.replace){a=a.replace(/\&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;")}return a};var encode_attrib_entities=function encode_attrib_entities(a){if(a==null){return""}if(a&&a.replace){a=a.replace(/\&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/\"/g,"&quot;");a=a.replace(/\'/g,"&apos;")}return a};var decode_entities=function decode_entities(a){if(a==null){return""}if(a&&a.replace&&a.match(/\&/)){a=a.replace(/\&lt\;/g,"<");a=a.replace(/\&gt\;/g,">");a=a.replace(/\&quot\;/g,'"');a=a.replace(/\&apos\;/g,"'");a=a.replace(/\&amp\;/g,"&")}return a};var compose_xml=function compose_xml(d,b,c){var f="";if(!c){c=0;f=xml_header+"\n";if(!b){b=first_key(d);d=d[b]}}var i="";for(var e=0;e<c;e++){i+=indent_string}if((typeof(d)=="object")&&(d!=null)){if(!d.length){f+=i+"<"+b;var m=0;var h=0;for(var l in d){m++}if(d["_Attribs"]){h=1;var a=hash_keys_to_array(d["_Attribs"]).sort();for(var j=0,g=a.length;j<g;j++){var l=a[j];f+=" "+l+'="'+encode_attrib_entities(d["_Attribs"][l])+'"'}}if(m>h){f+=">";if(d["_Data"]){f+=encode_entities(d["_Data"])+"</"+b+">\n"}else{f+="\n";var a=hash_keys_to_array(d).sort();for(var j=0,g=a.length;j<g;j++){var l=a[j];if((l!="_Attribs")&&l.match(re_valid_tag_name)){f+=compose_xml(d[l],l,c+1)}}f+=i+"</"+b+">\n"}}else{f+="/>\n"}}else{for(var j=0;j<d.length;j++){f+=compose_xml(d[j],b,c)}}}else{f+=i+"<"+b+">"+encode_entities(d)+"</"+b+">\n"}return f};var always_array=function always_array(c,b){if(b){if((typeof(c[b])!="object")||(typeof(c[b].length)=="undefined")){var a=c[b];delete c[b];c[b]=new Array();c[b][0]=a}return null}else{if((typeof(c)!="object")||(typeof(c.length)=="undefined")){return[c]}else{return c}}};var hash_keys_to_array=function hash_keys_to_array(b){var c=[];for(var a in b){c.push(a)}return c};var isa_array=function isa_array(a){return isArray(a)};var isa_hash=function isa_hash(a){return(!!a&&(typeof(a)=="object")&&!isa_array(a))};var first_key=function first_key(b){for(var a in b){return a}return null};var num_keys=function num_keys(d){var c=0;for(var b in d){c++}return c};